#!/usr/bin/env bash
# Git pre-push hook: run SonarQube analysis and block push if Quality Gate fails.

set -e

echo "======================================================"
echo "üîé Running SonarQube analysis before push..."
echo "   SonarQube URL: http://192.168.50.4:9000"
echo "======================================================"

# --- Check SONAR_TOKEN from environment ---
if [ -z "$SONAR_TOKEN" ]; then
  echo "‚ùå SONAR_TOKEN is not set."
  echo "   Please set it in your shell (PowerShell example):"
  echo "   $env:SONAR_TOKEN = \"your_sonar_token_here\""
  echo "Aborting push."
  exit 1
fi

# --- Optional: show branch name (info only) ---
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')"
echo "   Current branch: $BRANCH_NAME"

# --- Run sonar-scanner ---
echo "   Starting sonar-scanner..."
echo

sonar-scanner \
  -Dsonar.login="$SONAR_TOKEN" \
  -Dsonar.qualitygate.wait=true

STATUS=$?

echo
if [ $STATUS -ne 0 ]; then
  echo "‚ùå SonarQube analysis / Quality Gate FAILED (exit code $STATUS)."
  echo "   Check the results at: http://192.168.50.4:9000"
  echo "   Fix the reported issues before pushing."
  echo "======================================================"
  exit 1
fi

echo "‚úÖ SonarQube Quality Gate PASSED. Proceeding with push..."
echo "======================================================"
exit 0
